# ====================================================================
# GitHub Actions ワークフロー: 自動記事生成パイプライン
# ====================================================================
# このワークフローは、YouTube動画情報の収集から記事の生成・公開までを
# 自動で実行します。
#
# 実行タイミング:
# - 手動実行（workflow_dispatch）
# - スケジュール実行（毎日06:00 JST / 21:00 UTC, 18:00 JST / 09:00 UTC）
#
# 処理フロー:
# 1. Collector: YouTubeチャンネルから最新動画を収集 (YouTube Data API)
# 2. Researcher: 動画の選定と字幕取得、テーマ重複チェック (OpenAI API)
# 3. Generator: 記事の執筆・生成 (OpenAI API)
# 4. Publisher: 記事公開処理 (Git Commit)
# ====================================================================

name: content-pipeline

# ワークフローの実行トリガー設定
on:
  # 手動実行を許可（GitHub UI から実行可能）
  workflow_dispatch:

  # スケジュール実行（cron形式）
  schedule:
    # 06:00 JST / 21:00 UTC (previous day)
    - cron: '0 21 * * *'
    # 18:00 JST / 09:00 UTC
    - cron: '0 9 * * *'

# GitHub リポジトリへの書き込み権限を付与
# 生成された記事ファイルをコミット・プッシュするために必要
permissions:
  contents: write

jobs:
  # ====================================================================
  # メインジョブ: パイプライン実行
  # ====================================================================
  run-pipeline:
    # Ubuntu最新版の仮想環境で実行
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------------
      # ステップ1: リポジトリのチェックアウト
      # ----------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # 全ての履歴を取得（fetch-depth: 0）
          # これにより、git log や git diff が正常に動作します
          fetch-depth: 0

      # ----------------------------------------------------------------
      # ステップ2: Node.js環境のセットアップ
      # ----------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Node.js バージョン20を使用
          node-version: '20'

      # ----------------------------------------------------------------
      # ステップ3: 依存パッケージのインストール
      # ----------------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # ----------------------------------------------------------------
      # ステップ4: 記事生成パイプラインの実行
      # ----------------------------------------------------------------
      # 以下のAPIを使用して、動画収集から記事生成までを行います:
      # - YouTube Data API: 動画情報の収集
      # - OpenAI API: 記事構成案の作成、執筆、重複チェック
      - name: Run Content Pipeline
        env:
          # 必要なAPIキーをGitHub Secretsから取得して環境変数に設定
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}           # OpenAI API
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}         # YouTube Data API
          ARTICLES_PER_RUN: 1                                     # 1回の実行で生成する記事数
        run: npm run pipeline

      # ----------------------------------------------------------------
      # ステップ5: 生成されたコンテンツをGitにコミット・プッシュ
      # ----------------------------------------------------------------
      # 新しい記事ファイルやデータファイルの変更がある場合のみ、
      # 自動でコミット・プッシュします
      - name: Commit generated content
        run: |
          # git status --porcelain で変更ファイルの有無をチェック
          # 変更がある場合のみ以下の処理を実行
          if [ -n "$(git status --porcelain)" ]; then
            # Gitのユーザー情報を設定（GitHub Actions Bot として）
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # 全ての変更をステージングに追加
            git add .

            # 変更をコミット
            git commit -m "chore: auto-generate article via pipeline"

            # リモートリポジトリにプッシュ
            git push
          else
            # 変更がない場合はメッセージを表示して終了
            echo "No changes to commit."
          fi

